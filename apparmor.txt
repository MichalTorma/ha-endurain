#include <tunables/global>

profile endurian flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # Capabilities
  capability setgid,
  capability setuid,
  capability dac_override,
  capability dac_read_search,

  # S6-Overlay init system
  /init rix,
  /bin/** rix,
  /usr/bin/** rix,
  /sbin/** rix,
  /usr/sbin/** rix,
  /run/{s6,s6-rc*,service}/** rwix,
  /package/** rix,
  /command/** rix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /etc/s6-overlay/** rwix,
  /etc/s6-overlay/s6-rc.d/** rwix,
  /run/{,**} rwk,
  /var/run/** rwk,
  /dev/tty rw,

  # Bashio
  /usr/lib/bashio/** rix,
  /tmp/** rwk,

  # Access to options.json and other addon-specific files
  /data/** rw,

  # Access to Home Assistant directories
  /config/** rw,
  /share/** rw,
  /ssl/** r,

  # Python and application files
  /usr/bin/python3 rix,
  /opt/venv/bin/python rix,
  /opt/venv/** r,
  /app/** rix,
  /usr/lib/python3*/** r,
  /usr/local/lib/python3*/** r,
  
  # Startup script
  /usr/bin/start-endurian.sh rix,

  # Network access for PostgreSQL and web interface
  network inet,
  network inet6,

  # System files
  /etc/passwd r,
  /etc/group r,
  /etc/hostname r,
  /etc/hosts r,
  /etc/localtime r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/ssl/certs/** r,
  /etc/ca-certificates/** r,
  /usr/share/ca-certificates/** r,

  # Proc filesystem
  @{PROC}/sys/net/core/somaxconn r,
  @{PROC}/meminfo r,
  @{PROC}/stat r,
  @{PROC}/cpuinfo r,
  @{PROC}/loadavg r,
  @{PROC}/version r,
  @{PROC}/self/stat r,
  @{PROC}/self/status r,

  # Python needs access to random devices
  /dev/random r,
  /dev/urandom r,
  /dev/null rw,
  /dev/zero r,

  # Allow application to write logs
  /var/log/endurian/** rw,

  # Temporary files
  /tmp/** rw,

  # Application uploads and data
  /share/endurian/** rw,
  /config/endurian/** rw,

  # Library access
  /lib/** mr,
  /usr/lib/** mr,

  # Signal handling
  signal (receive) set=(term, int, quit, usr1, usr2),

  # Deny dangerous capabilities
  deny capability mac_admin,
  deny capability mac_override,
  deny capability sys_admin,
  deny capability sys_module,
}
